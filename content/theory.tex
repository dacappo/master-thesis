\chapter{Classification of NoSQL Injection Attacks}
\label{cha:classification}
This chapter analysis the found injection attacks and classifies them according to the underlying problem. In the course of this, four major issues were identified, that cause injection vulnerabilities in non-relational databases. These classes are outlined in the following sections with reference to the corresponding attacks of the previous chapter.

\section{Object Structure Defined Semantic}
With the emergence of non-relational databases, JSON became a prevailing format for the storage of data records. The document stores MongoDB and CouchDB are prominent examples for JSON-structured data persistence. Given this storage structure, utilizing the same format for query criteria suggested itself. The JSON-format allows to state property-value combinations, that have to be match the stored data. For more complex query criteria, the JSON format has to be extended. The investigated document stores achieve this with objects, that contain special keys. This structure represents a comprehensible notation for humans and mirrors the stored data records. In theory, also other formats could be applied instead of JSON. A query's semantic is therefore defined by the structure and properties of its parameters. As known from other query languages, the semantic defining elements have to be protected from injection attacks. In the case of SQL injection, these semantic defining elements are special characters of a string. For the investigated document stores, the semantic is encoded in the object structure of parameters. On account of this, the type and structure of user-provided values have to be validated. Without suchlike sanitizing, the parameter structure and type can be changed by injection attacks. Unfortunately, the awareness of potential object structure and type injection is not very widespread. Restricting user-provided data to strings or integer values does not represent a feasible solution, since flexibility of parameters is required to work with unstructured data. A case differentiation between sensitive and benign parameter structures is needed. This differentiation has to be accomplished within the application layer, since the sensitivity of parameter highly depends on the intended use case. Authentication or authorization operations are highly sensitive, whereas operations on public data be rather harmless. The required case differentiation exhibits a conceptional problem of the query technique regarding injection attacks.\\

This class of attacks was exposed by the results of the preceding investigation. The query selector injection against MongoDB as well as the find selector injection against CouchDB are based upon this conceptional issue. The problem has to be solved by proper structure and type sanitizing depending on the intended use case.

\section{Diverging Parameter Handling}
This class of attacks rests upon differences in the handling of parameters between application and database layer. These differences are crucial, since the concept of non-relational databases depends on application layer data checks. Reasons for the differences can be automatic format or type conversions within the database layer and driver. Two diverging parameters may be converted to the same value and therefore result in the same database operation. An example could be an array, that is automatically split into its components. This leads to multiple parameter combinations, that trigger the same database operation due to the the preliminary conversion. Before the conversion, the diverging parameters lead to varied behavior of the application layer processing. Prevention of disallowed database operations by application layer checks becomes hard to ensure, since multiple parameter combinations exist for a distinct operation. Such diverging handling of parameters is often not documented and therefore hard to consider within the application layer code. The underlying reason for the problematic conversions can be conceptional issues as well as implementation flaws.\\

The previous investigation exhibited multiple examples that lead to this class of attacks. Practical instances for this class of attacks are the expanding array injection against MongoDB, where elements of stored arrays are automatically extracted for comparison. The array value injection against CouchDB as well as the array key injection against Memcached automatically retrieve elements from arrays, when another value type is required for the operation. Redis's parameter overwrite injection allows two ways to pass arguments and converts them within the database driver. The problem has to be solved by proper structure and type sanitizing within the application layer, since these attacks rely on data type conversions.

\section{Shared Scope for Data}
Another class of injection attacks of non-relational databases is caused by shared storage scopes for multiple purposes. A storage scope can be a seen as a delimited database section, such as a table or collection. Normally, data from different applications is stored in separate scopes. This situation changes with non-relational databases. The support for unstructured data enables the storage of various data formats within a single scope. This capability may be used of applications or the database itself, to combine varied information within a single scope. An example is the storage of meta information next to normal data records within a single scope. In order to handle this correctly, the application layer has to be aware of the variety of formats. Since the concept of shared storage scopes is relatively new, many applications may only expect a single format within a storage scope. Other formats are therefore not considered within the application layer and may lead to unexpected data processing. Attacks of this class make use of this situation by manipulating queries in order to retrieve or insert unexpected data formats. For known attacks, this class is based on the conceptional design of the underlying database. \\

The investigation of the selected databases showed, that shared storage scopes are actually employed. CouchDB stores meta data as documents within the corresponding collections. This results in data records, that are accessible for each user on each collection by default. When these meta data records are not considered within the application layer processing, unintended behavior can be triggered through query injection. The special key injection against CouchDB proves, that such attacks can be critical. A shared storage scope also plays an important role for the data import injection affecting CouchDB. Thereby, mixed data formats within a single collection allow the execution of user-controlled JavaScript functions.

\section{Error-prone String Escaping}
The last class of attacks against NoSQL databases encompasses a problem, already known from its relational counterparts. Concatenation of strings with user-provided parameters has to be approached with caution. As known form SQL, each untrusted string has to be escaped for the intended target context. This rule does not only apply to SQL, but to all strings interpreted within the database layer. The new generation of non-relational databases employs various scripting languages and string parameters, whose parameters have to be properly sanitized. User-controlled data should never be in control of the semantic structure of such strings. Therefore, all control characters of the targeted context have to be escaped. Missing or incomplete escaping enables an attacker to manipulate the semantic of the later-on interpreted string. The described problem applies to all strings with a dedicated structure, that are interpreted within the database layer. \\

This class of injection attacks is already known, but applies to a variety of contexts regarding non-relational databases. Mitigation techniques for this kind of problem exist, but the findings of this thesis imply, that missing or error-prone parameter escaping still represents a severe problem. The targeted contexts changed, but the underlying problem is still the same. URL traversal injections, as found for CouchDB, belong to this class of error-prone string escaping. Other studies discovered multiple of this problems with regard to map-reduce function injection. This class compromises string defined semantics and therefore represents the counterpart to the first class, that attacks object structure defined semantics.\\

\section{Classification Overview}
This section summarizes the previous attack classification and gives an overview of the the underlying design problems. Table \ref{tab:attack_classification_overview} assigns each attack of the previous chapter to a distinct class. \\

\begin{table}[h]
  \sffamily
  \centering 
  \begin{tabular}{lll}
  \textbf{Class} & \textbf{Attack} & \textbf{Database} \\ \hline
  \multirow{2}{*}{Object Structure Defined Semantic}
    & Query Selector Injection & MonogDB \\
    & Find Selector Injection & CouchDB \\ \hdashline
  \multirow{4}{*}{Diverging Parameter Handling}
    & Expanding Array Injection & MonogDB \\
    & Parameter Overwrite Injection & Redis \\
    & Array Value Injection & CouchDB \\
    & Array Key Injection & Memcached \\ \hdashline
  \multirow{2}{*}{Shared Scope for Data}
    & Special Key Injection & CouchDB \\
    & Data Import Injection & CouchDB \\ \hdashline
  \multirow{1}{*}{Error-prone String Escaping}
    & URL Traversal Injection & CouchDB \\ \hline
  \end{tabular}
  \caption{Classification overview of the found injection attacks according to the underlying problem}
  \label{tab:attack_classification_overview}
\end{table}

The table shows that the new approach of object structure defined semantic leads to serious problems. Automatic parameter conversion within the database layer leads to diverging parameter handling and injection vulnerabilities across all investigated databases. Shared scopes for data storage are only present in case of CouchDB, but also expose a threat for injection attacks. Even the well known problem of error-prone string escaping represents still a major issue for certain contexts, such as REST URLs. With the given classification of all found injection attacks and analysis of the according design problems, \textbf{Objective 3} is covered.